generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum UserRole {
  ADMIN
  GUEST
  HOST
}

enum UserType {
  ADMIN
  GUEST
  HOST
}

enum ListingStatus {
  DRAFT
  PUBLISHED
  SUSPENDED
  ARCHIVED
}

enum CancellationPolicy {
  FLEXIBLE
  MODERATE
  STRICT
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  STRIPE
  CASH
  PAYPAL
}

enum CallStatus {
  PENDING
  ACCEPTED
  REJECTED
  MISSED
  COMPLETED
  CANCELLED
}


model User {
  id                    String              @id @default(uuid())
  fullName              String
  mobile                String              @unique
  email                 String?             @unique
  passwordHash          String?
  isVerified            Boolean             @default(false)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  isActive              Boolean             @default(true)
  lastLoginAt           DateTime?
  oauthId               String?
  oauthProvider         String?
  role                  UserRole            @default(GUEST)
  type                  UserType
  dailyLimit            Int                 @default(3)
  totalLimit            Int                 @default(100)
  profileImage          String?
  phoneNumber           String?
  bio                   String?

  // Relations
  loginAttempts         LoginAttempt[]
  refreshTokens         RefreshToken[]
  otpAttempts           OtpAttempt[]
  otps                  OtpCode[]           @relation("UserOtps")
  listings              Listing[]
  bookings              Booking[]

  @@index([mobile])
  @@index([email])
  @@map("users")
}

model OtpCode {
  id                    String              @id @default(uuid())
  mobile                String
  hashedCode            String
  userId                String?
  expiresAt             DateTime
  resendAllowedAt       DateTime?
  createdAt             DateTime            @default(now())
  user                  User?               @relation("UserOtps", fields: [userId], references: [id])

  @@index([mobile])
  @@map("otp_codes")
}

model OtpAttempt {
  id                    String              @id @default(uuid())
  mobile                String              @unique
  attempts              Int                 @default(0)
  blockedUntil          DateTime?
  updatedAt             DateTime            @updatedAt
  createdAt             DateTime            @default(now())
  userId                String?
  user                  User?               @relation(fields: [userId], references: [id])

  @@map("otp_attempts")
}

model LoginAttempt {
  id                    String              @id @default(uuid())
  mobile                String              @unique
  attempts              Int                 @default(0)
  blockedUntil          DateTime?
  updatedAt             DateTime            @updatedAt
  createdAt             DateTime            @default(now())
  userId                String?
  user                  User?               @relation(fields: [userId], references: [id])

  @@map("login_attempts")
}

model RefreshToken {
  id                    String              @id @default(uuid())
  token                 String              @unique
  userId                String
  expiresAt             DateTime
  createdAt             DateTime            @default(now())
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}


model Listing {
  id                    String              @id @default(uuid())
  title                 String
  description           String              @db.LongText
  address               String
  googleMapsUrl         String?
  city                  String
  price                 Decimal             @db.Decimal(10, 2)
  images                ListingImage[]
  status                ListingStatus       @default(DRAFT)
  rules                 String?             @db.LongText
  cancellationPolicy    CancellationPolicy  @default(FLEXIBLE)
  host                  User                @relation(fields: [hostId], references: [id], onDelete: Cascade)
  hostId                String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  bookings              Booking[]
  calendar              CalendarItem[]

  @@index([city])
  @@index([status])
  @@index([hostId])
  @@map("listings")
}

model ListingImage {
  id                    String              @id @default(uuid())
  listingId             String
  path                  String
  filename              String
  mime                  String
  listing               Listing             @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt             DateTime            @default(now())

  @@index([listingId])
  @@map("listing_images")
}

model Booking {
  id                    String              @id @default(uuid())
  userId                String
  listingId             String
  startDate             DateTime
  endDate               DateTime
  status                BookingStatus       @default(PENDING)
  totalPrice            Decimal             @db.Decimal(10, 2)
  cancellationReason    String?
  cancelledAt           DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing               Listing             @relation(fields: [listingId], references: [id], onDelete: Cascade)
  payment               Payment?

  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("bookings")
}

model CalendarItem {
  id                    String              @id @default(uuid())
  listingId             String
  date                  DateTime
  isBooked              Boolean             @default(false)

  listing               Listing             @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@map("calendar_items")
}

model Payment {
  id                    String        @id @default(uuid())
  bookingId             String        @unique
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("SAR")
  status                PaymentStatus @default(PENDING)
  paymentMethod         PaymentMethod @default(STRIPE)

  stripePaymentId       String?       @unique
  stripeClientSecret    String?

  // NEW PayPal fields
  paypalOrderId         String?       @unique
  paypalCaptureId       String?       @unique

  refundAmount          Decimal?      @db.Decimal(10, 2)
  refundedAt            DateTime?
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  booking               Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([stripePaymentId])
  @@index([bookingId])
  @@map("payments")
}


